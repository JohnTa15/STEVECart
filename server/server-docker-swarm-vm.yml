services:
  golang:
    image: golang:latest
    ports:
      - target: 8089
        published: 8089
        protocol: tcp
    networks:
      - smart_cart_network
      - sensors_network
    volumes:
      - ./steve-api/:/app
    working_dir: /app
    entrypoint: ["/app/entrypoint.sh"]
    environment:
      - DB_URL=uniwa_admin:adminUNIWA@tcp(mariadb:3306)/supermarket_db
      - DB_HOST=mariadb
      - DB_NAME=supermarket_db
      - INFLUX_DB=http://influxdb:8086
      - INFLUX_TOKEN=adminUNIWAsuper
      - MQTT_BROKER=tcp://mosquitto:1884
      - DB_URL=uniwa_admin:adminUNIWA@tcp(percona_cluster_1:3306)/supermarket_db?tls=skip-verify
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  influxdb:
    image: influxdb:2.7.12
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_logs:/var/log/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminUNIWA
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=adminUNIWAsuper
      - DOCKER_INFLUXDB_INIT_ORG=UNIWA
      - DOCKER_INFLUXDB_INIT_BUCKET=sensors
    networks:
      - sensors_network
    deploy:
      replicas: 1

  percona_cluster_1:
    image: percona/percona-xtradb-cluster:latest
    ports:
      - "3306:3306"
    volumes:
      # - ./percona_cluster/percona_data_1:/var/lib/mysql
      - ./percona_cluster/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./alpine/ssl_certs/ca.pem:/etc/mysql/certs/ca.pem
      - ./alpine/ssl_certs/server-cert.pem:/etc/mysql/certs/server-cert.pem
      - ./alpine/ssl_certs/server-key.pem:/etc/mysql/certs/server-key.pem
    environment:
      CLUSTER_NAME: pxc-cluster
      XTRABACKUP_PASSWORD: 6RG1hSltfljC9e
      MYSQL_ROOT_PASSWORD: rootUNIWA
      MYSQL_DATABASE: supermarket_db
      MYSQL_USER: uniwa_admin
      MYSQL_PASSWORD: adminUNIWA
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --pxc-encrypt-cluster-traffic=ON
      --ssl-ca=/etc/mysql/certs/ca.pem
      --ssl-cert=/etc/mysql/certs/server-cert.pem
      --ssl-key=/etc/mysql/certs/server-key.pem
    networks:
      - smart_cart_network
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  percona_cluster_2:
    image: percona/percona-xtradb-cluster:latest
    volumes:
      # - ./percona_cluster/percona_data_2:/var/lib/mysql
      - ./alpine/ssl_certs/ca.pem:/etc/mysql/certs/ca.pem
      - ./alpine/ssl_certs/server-cert.pem:/etc/mysql/certs/server-cert.pem
      - ./alpine/ssl_certs/server-key.pem:/etc/mysql/certs/server-key.pem
    environment:
      CLUSTER_NAME: pxc-cluster
      CLUSTER_JOIN: percona_cluster_1
      XTRABACKUP_PASSWORD: 6RG1hSltfljC9
      MYSQL_ROOT_PASSWORD: rootUNIWA
      MYSQL_DATABASE: supermarket_db
      MYSQL_USER: uniwa_admin
      MYSQL_PASSWORD: adminUNIWA
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --pxc-encrypt-cluster-traffic=ON
      --ssl-ca=/etc/mysql/certs/ca.pem
      --ssl-cert=/etc/mysql/certs/server-cert.pem
      --ssl-key=/etc/mysql/certs/server-key.pem
    networks:
      - smart_cart_network
    deploy:
      replicas: 1
    depends_on:
      - percona_cluster_1

  percona_cluster_3:
    image: percona/percona-xtradb-cluster:latest
    volumes:
      # - ./percona_cluster/percona_data_3:/var/lib/mysql
      - ./alpine/ssl_certs/ca.pem:/etc/mysql/certs/ca.pem
      - ./alpine/ssl_certs/server-cert.pem:/etc/mysql/certs/server-cert.pem
      - ./alpine/ssl_certs/server-key.pem:/etc/mysql/certs/server-key.pem
    environment:
      CLUSTER_NAME: pxc-cluster
      CLUSTER_JOIN: percona_cluster_1
      XTRABACKUP_PASSWORD: 6RG1hSltfljC9e
      MYSQL_ROOT_PASSWORD: rootUNIWA
      MYSQL_DATABASE: supermarket_db
      MYSQL_USER: uniwa_admin
      MYSQL_PASSWORD: adminUNIWA
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --pxc-encrypt-cluster-traffic=ON
      --ssl-ca=/etc/mysql/certs/ca.pem
      --ssl-cert=/etc/mysql/certs/server-cert.pem
      --ssl-key=/etc/mysql/certs/server-key.pem
    networks:
      - smart_cart_network
    deploy:
      replicas: 1
    depends_on:
      - percona_cluster_1

  mosquitto:
    image: eclipse-mosquitto:latest
    ports:
      - "1884:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - sensors_network 
    deploy:
      replicas: 1

networks:
  smart_cart_network:
    driver: overlay
    attachable: true
  sensors_network:
    driver: overlay
    attachable: true

volumes:
  percona_data_1:
  percona_data_2:
  percona_data_3:
  influxdb_data:
  influxdb_logs:


# Leave Swarm if needed (already in Swarm)
# docker stack deploy -c server.yml smartcart

# Check services
# docker stack services smartcart

# Remove stack
# docker stack rm smartcart
# https://docs.percona.com/percona-xtradb-cluster/8.0/docker.html
# docker service ps smartcart_golang --no-trunc